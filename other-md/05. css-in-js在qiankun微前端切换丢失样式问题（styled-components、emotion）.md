# css-in-jsåœ¨qiankunå¾®å‰ç«¯åˆ‡æ¢ä¸¢å¤±æ ·å¼é—®é¢˜ï¼ˆstyled-components/emotionï¼‰

## èƒŒæ™¯

- å¿«é€Ÿæ–¹æ¡ˆA: ç›®å‰ä½¿ç”¨ç°ä»£ css style sheet ä¹Ÿå°±æ˜¯ cssom çš„ api å»æ“ä½œæ ·å¼æ˜¯æ€§èƒ½æœ€å¥½çš„ï¼Œä¼šæŠŠä¸€å † css æ”¾åˆ°ä¸€ä¸ª `<style></style>` æ ‡ç­¾é‡Œï¼Œè¿™ç§æ–¹æ¡ˆé€Ÿåº¦å¾ˆå¿«ï¼Œæ”¯æŒä¸‡çº§åˆ«çš„æ ·å¼æ’å…¥
- æ…¢é€Ÿæ–¹æ¡ˆB	è€Œæ—©æœŸæ˜¯ä¸€ä¸ª style æ ‡ç­¾å¯¹åº”æ’å…¥ä¸€ä¸ªæ ·å¼ï¼Œè¿™æ ·ä¼šæ¯”è¾ƒæ…¢ï¼Œä½†æ˜¯ä»–åœ¨å¼€å‘ç¯å¢ƒä¼šå¾ˆæ–¹ä¾¿äºä¿®æ”¹å’Œè°ƒè¯•


## é—®é¢˜

é—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

é—®é¢˜æ˜¯åœ¨ qiankun é‡Œï¼Œéç¬¬ä¸€æ¬¡åŠ è½½åŒä¸€ä¸ªå­åº”ç”¨æ—¶ï¼ˆæ¯”å¦‚åˆ‡æ¢äº†å­åº”ç”¨æˆ–è€…åœ¨ä¸»åº”ç”¨å’Œå­åº”ç”¨é—´åˆ‡æ¢ï¼‰ï¼Œä¼šéšæœºæ€§äº§ç”Ÿä¸¢å¤± cssom çš„æ ·å¼é—®é¢˜ï¼Œå¯è§ç›¸å…³ issue ï¼š

- https://github.com/umijs/qiankun/issues/637
- https://github.com/umijs/qiankun/issues/617
- https://github.com/umijs/qiankun/issues/1426
- https://github.com/umijs/qiankun/issues/2603
- æ›´å¤šè§ï¼šhttps://github.com/umijs/qiankun/issues?q=is%3Aissue+styled
- https://stackoverflow.com/questions/53486470/react-styled-components-stripped-out-from-production-build

## è§£æ³•

æœ‰äº†ä»¥ä¸ŠåŸºç¡€çŸ¥è¯†é“ºå«ï¼Œå¾ˆæ˜æ˜¾ï¼Œæ—¢ç„¶æ˜¯ cssom å¯¼è‡´çš„ï¼Œé‚£æˆ‘ä»¬åªéœ€è¦å°†å…¶ å¿«é€Ÿæ–¹æ¡ˆA åˆ‡æ¢ä¸º æ…¢é€Ÿæ–¹æ¡ˆB ï¼Œè¿”ç’å½’çœŸå³å¯ã€‚

ä»¥ä¸‹ä»‹ç»ä¸¤ä¸ªåº“ï¼ˆ styled-components å’Œ emotion ï¼‰çš„å…·ä½“è§£æ³•ï¼Œå…¶ä»–åº“å‡åŒç†ï¼Œè¯·è‡ªè¡Œæ¢ç´¢æºç ã€‚

### styled-components

sc æœ‰ä¸¤ç§è§£æ³•ï¼Œä¸ºäº†å›é€€åˆ° B æ—§æ’å…¥æ¨¡å¼ï¼Œé…ç½®å¤–å±‚ Context å³å¯ï¼š

```ts
import { StyleSheetManager } from 'styled-components'

export default function App() {

  return (
    <StyleSheetManager disableCSSOMInjection>
      {/* ... */}
    </StyleSheetManager>
  )
}
```

æ­¤å¤„ disableCSSOMInjection å³ä»£è¡¨å›é€€åˆ°æ—§å¼å• style å¯¹åº”å• css æ–¹æ¡ˆã€‚

- å®˜æ–¹ APIï¼š https://styled-components.com/docs/api#stylesheetmanager

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è§£ï¼Œä»¥ä¸‹æ˜¯æºç ç‰‡æ®µï¼Œæˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªé€»è¾‘ï¼š

```ts
// é»˜è®¤å€¼é€»è¾‘

const defaultOptions: SheetOptions = {
  isServer: !IS_BROWSER,
  // â†“ è¿™é‡Œæ˜¯è¯¥ option çš„é»˜è®¤å€¼è·å–å¤„
  useCSSOMInjection: !DISABLE_SPEEDY,
};

// â†“ é€šè¿‡ç¯å¢ƒå˜é‡åˆ¤æ–­äº†é»˜è®¤å–å€¼
export const DISABLE_SPEEDY = Boolean(
  typeof SC_DISABLE_SPEEDY === 'boolean'
    ? SC_DISABLE_SPEEDY
    : typeof process !== 'undefined' &&
      typeof process.env.REACT_APP_SC_DISABLE_SPEEDY !== 'undefined' &&
      process.env.REACT_APP_SC_DISABLE_SPEEDY !== ''
    ? process.env.REACT_APP_SC_DISABLE_SPEEDY === 'false'
      ? false
      : process.env.REACT_APP_SC_DISABLE_SPEEDY
    : typeof process !== 'undefined' &&
      typeof process.env.SC_DISABLE_SPEEDY !== 'undefined' &&
      process.env.SC_DISABLE_SPEEDY !== ''
    ? process.env.SC_DISABLE_SPEEDY === 'false'
      ? false
      : process.env.SC_DISABLE_SPEEDY
    : process.env.NODE_ENV !== 'production'
);
```

ä¹Ÿå°±æ˜¯è¯´ä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹é…ç½® env ç¯å¢ƒå˜é‡å®ç°é»˜è®¤å…³é—­ï¼š

```ts
// .env
SC_DISABLE_SPEEDY=false
// or (in cra, `REACT_APP` prefix env will auto inject)
REACT_APP_SC_DISABLE_SPEEDY=false
```

### emotion

emotion çš„è§£æ³•ä¹ŸåŒç†ï¼Œé…ç½® speedy ä¸º false å³å¯ï¼Œæ³¨æ„ä½ éœ€è¦æå‰å®‰è£… @emotion/cache åŒ…æ¥æä¾›å¤–å±‚è‡ªå®šä¹‰ Contextï¼Œå› ä¸º emotion ä¼šç¼“å­˜ style åˆ° cache store å†…ï¼š

pnpm i @emotion/cache

é…ç½® Cache Contextï¼š

```ts
import createCache from '@emotion/cache'
import { CacheProvider } from '@emotion/react'

const myCache = createCache({
  key: 'x',
  speedy: false,
})

export default function App() {

  return (
    <CacheProvider value={myCache}>
      {/* ... */}
    </CacheProvider>
  )
}
```

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œemotion è¿™é‡Œå¿…é¡»è¦é…ç½®å”¯ä¸€ key ä½œä¸ºæ‰€æœ‰æ ·å¼çš„ prefix ï¼Œæ˜¯ä¸€ä¸ªä¸å¤ªå¥½çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯è¯´è‡³å°‘ç»™æˆ‘ä»¬å¸¦æ¥äº† n * 1 ä¸ªå­—èŠ‚çš„ä½“ç§¯å¢å¤§ï¼ˆ n ä¸º emotion ä½¿ç”¨æ¬¡æ•° ï¼‰ã€‚

æºç ï¼š
```ts
// ç‰‡æ®µ 1ï¼šé»˜è®¤å€¼é€»è¾‘
constructor(options: Options) {
  this.isSpeedy =
    options.speedy === undefined
      ? process.env.NODE_ENV === 'production'
      : options.speedy
}

// --------------------------------------------

// ç‰‡æ®µ 2ï¼šæ’å…¥æ ‡ç­¾éƒ¨åˆ†é€»è¾‘
insert(rule: string) {

  // ğŸŒˆ è¿™é‡Œå¦‚æœæ˜¯ false å°±ä¼šåªæ’å…¥ä¸€ä¸ªæ ‡ç­¾
  if (this.ctr % (this.isSpeedy ? 65000 : 1) === 0) {
    this._insertTag(createStyleElement(this))
  }

  // ...çœç•¥å¾ˆå¤šè¡Œ

  if (this.isSpeedy) {
    const sheet = sheetForTag(tag)
    
    // ...çœç•¥å¾ˆå¤šè¡Œ
    
  } else {
  	// ğŸŒˆ é cssom å¼æ“ä½œ
    tag.appendChild(document.createTextNode(rule))
  }
  
}
```

å¦‚æœä»¥ä¸Šæºç éƒ½çœ‹ä¸æ‡‚ä¹Ÿæ— æ‰€è°“ï¼Œåªè¦è®°ä½ speedy è¿™ä¸ªè¯æ˜¯ä»£è¡¨å¿«é€Ÿæ’å…¥å³å¯ï¼Œå¦‚æœæ˜¯å…¶ä»– css in js åº“å¯ä»¥æœç€ speedy å…³é”®è¯æ‰¾ã€‚

å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œä¸ºäº†ä¾¿äºè°ƒè¯•å’Œä¿®æ”¹ï¼Œä¸ç®¡æ˜¯ sc è¿˜æ˜¯ emotion é»˜è®¤éƒ½å¼€å¯äº† æ…¢é€Ÿæ¨¡å¼B ï¼ˆå¯åœ¨ä¸Šé¢çš„æºç ç‰‡æ®µä¸­è¿½æº¯ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯åœ¨æœ¬åœ°ä¸ä¼šå‘ç°ç«¯å€ªæ„å»ºåæ‰å‡ºç°é—®é¢˜çš„ä¸€ä¸ªç‚¹ã€‚

## æ€»ç»“

æœ€åæ€»ç»“æ€è€ƒä¸‹ï¼š

1. ä¸ºäº†é¿å… qiankun é—®é¢˜ï¼Œä¸æ”¹åŠ¨ qiankun ä»£ç çš„å‰æä¸‹ï¼Œå›é€€åˆ° Bæ–¹æ¡ˆ æ˜¯ç›®å‰å”¯ä¸€è§£ï¼Œå› æ­¤é€‰æ‹© sc è¿˜æ˜¯ emotion è°å¿«è°æ…¢åº”è¯¥æ²¡åŒºåˆ«äº†ï¼Œä¹Ÿå°±æ˜¯è¯´äº«å—ä¸åˆ° cssom è¿˜æ˜¯åº“ä¼˜åŒ–çš„å¥½å¤„ã€‚
2. emotion ä½¿ç”¨å§¿åŠ¿å¾ˆå¤šï¼Œsc æ¯”è¾ƒå•ä¸€ï¼Œä½† emotion å¤šå§¿åŠ¿çš„ä»£ä»·æ˜¯è¦å…¼å®¹ä»–çš„ css å¯¹åº”çš„ jsx runtime æ³¨å…¥ï¼Œè¿™éœ€è¦é¢å¤–çš„ babel å·¥ä½œé‡ã€‚
3. å›é€€åˆ° Bæ–¹æ¡ˆ æ—¶ï¼Œsc é…ç½®æ¯”è¾ƒçµæ´»ï¼ˆç”šè‡³æ”¯æŒç¯å¢ƒå˜é‡éšå¼é…ç½®ï¼‰ï¼Œè€Œ emotion é…ç½®ç¨å¤æ‚ï¼Œè¿˜å­˜åœ¨ä½“ç§¯å¢å¤§çš„å‰¯ä½œç”¨ã€‚
4. ç”¨ css in js å°±è¦ babel æ’ä»¶å‹ç¼©ï¼ŒåŒæ—¶æœ‰äº† babel æ’ä»¶æ‰èƒ½åœ¨å¼€å‘æ—¶æ˜¾ç¤ºç±»åï¼Œè€Œåˆ°äº† swc æœªæ¥ï¼Œnextjs æ­£åœ¨å†™ sc çš„ swc æ’ä»¶ï¼Œæœ‰ roadmapï¼Œè¿›åº¦è™½ç„¶ç¼“æ…¢ï¼Œä½† emotion çš„ swc æ’ä»¶å´è¿˜æ²¡æ‰“ç®—å†™ï¼Œç”šè‡³éƒ½ä¸ç”¨è¯´è¿›åº¦äº†ã€‚

ç»¼åˆæ¥çœ‹ï¼Œå»ºè®®ä½¿ç”¨ sc æ¯”è¾ƒé¢å‘æœªæ¥ï¼Œå½“ç„¶æ˜¯åœ¨ qiankun åœºæ™¯ä¸‹ï¼Œå¦‚æœé qiankun åœºæ™¯ï¼Œå»ºè®®ä½¿ç”¨ emotion ã€‚
