# 微前端技术对比与评估

## 前端微服务化的几种方式

| 方式 | 开发成本 | 维护成本 | 可行性 | 同一框架要求 | 实现难度 | 潜在风险 |
| --- | --- | --- | --- | --- | --- | --- |
| 路由分发 | 低 | 低 | 高 | 否 | 1 | 这个方案太普通了 |
| iFrame | 低 | 低 | 高 | 否 | 1 | 这个方案太普通了 |
| 应用微服务化 | 高 | 低 | 中 | 否 | 4 | 针对每个框架做定制及 Hook |
| 微件化 | 中 | 中 | 低 | 是 | 5 | 针对构建系统，如 webpack 进行 hack |
| 微应用化 | 中 | 中 | 高 | 是 | 3 | 统一不同应用的构建规范 |
| 纯 Web Components | 高 | 低 | 高 | 否 | 2 | 新技术，浏览器的兼容问题 |
| 结合 Web Components | 高 | 低 | 高 | 否 | 2 | 新技术，浏览器的兼容问题 |

## 微前端方案的复杂方式对比

| 架构目标 | 描述 |
| --- | --- |
| a. 独立开发 | 独立开发，而不受影响 |
| b. 独立部署 | 能作为一个服务来单独部署 |
| C. 支持不同框架 | 可以同时使用不同的框架，如 Angular、 Vue、React |
| d. 摇树优化 | 能消除未使用的代码 |
| e. 环境隔离 | 应用间的上下文不受干扰 |
| f. 多个应用同时运行 | 不同应用可以同时运行 |
| g. 共用依赖 | 不同应用是否共用底层依赖库 |
| h. 依赖冲突 | 依赖的不同版本是否导致冲突 |
| i. 集成编译 | 应用最后被编译成一个整体，而不是分开构建 |

对比（WC是web component的缩写）：

| 方式 | a | b | c | d | e | f | g | h | i |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
|路由分发 | O | O | O | O | O | O |  |  |  |
|iFrame | O | O | O | O | O | O |  |  |  |
|应用微服务化 | O | O | O |  |  | O |  |  |  |
|微件化 | O | O |  |  | - | - | O | - |  |
|微应用化 | O | O |  | O | - | - | O | - | O |
|纯 WC | O | O |  | O | O | O | - | - | O |
|结合 WC | O | O | O | O | O | O |  |  | O |

图中的 O 表示支持，空白表示不支持，- 表示不受影响。

## 前端微服化

对于前端微服化来说，有这么一些方案：

- Web Component 显然可以一个很优秀的基础架构。然而，我们并不可能去大量地复写已有的应用。
- iFrame。其实在某些特定情况下还是可以考虑使用。
- 另外一个微前端框架 Single-SPA，显然是一个更好的方式。然而，它并非 是一个开箱即用的工具，非production ready。
- 通过路由来切分应用，而这个跳转会影响用户体验。
- 等等。

因此，当我们考虑前端微服务化的时候，我们希望：

- 独立部署
- 独立开发
- 技术无关
- 不影响用户体验

### 现有市面上微前端框架的问题

综合看过的几个框架来看，现有的微前端框架基本都能满足我们的使用了，无论是加载异构前端项目，还是应用的拉起销毁。但是也存在着相应的缺陷。

- 应用插槽、注入式组件、动态组件的暴露方案未提供
- 应用的共用依赖均不能进行整合加载
- 应用上下文无法隔离
- 无法整体打包构建、摇树优化

### 现有微前端通讯机制评估

    注：single-spa只是应用聚合，无通讯能力。

1. qiankun的通讯机制

    [源码](https://github.com/umijs/qiankun/blob/master/src/globalState.ts)

qiankun采用的通讯方式是定义变量，键为监听名，值为事件回调。

缺点：

- 对于混合微前端方式不友好，如跨标签页、iframe内嵌通讯
- 对于事件不能自定义，单一应用只有一个回调可用
- 不可剥离微前端框架

2. Icestark飞冰的通讯机制@ice/stark-data

    [源码](https://github.com/ice-lab/icestark/tree/master/packages/icestark-data)

飞冰采用的通讯方式是Event+emit，并将所有的事件放到window.store下管理。

缺点：

- 对于混合微前端方式不友好，如跨标签页、iframe内嵌通讯
- window对象托管store不安全，易被数据劫持和篡改

